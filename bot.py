import tweepy
from openai import OpenAI
import sys
import io
import os
import datetime

# æ–‡å­—åŒ–ã‘å¯¾ç­–
sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

def main():
    print("è©³ç´°ï¼šæ¶ç©ºè¬ç½ªä¼šè¦‹Botï¼ˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ãƒ»å®Œå…¨ç‰ˆï¼‰ã‚’é–‹å§‹ã—ã¾ã™...")

    # ==================================================
    # éµã®èª­ã¿è¾¼ã¿
    # ==================================================
    try:
        X_API_KEY = os.environ["X_API_KEY"]
        X_API_SECRET = os.environ["X_API_SECRET"]
        X_ACCESS_TOKEN = os.environ["X_ACCESS_TOKEN"]
        X_ACCESS_TOKEN_SECRET = os.environ["X_ACCESS_TOKEN_SECRET"]
        OPENAI_API_KEY = os.environ["OPENAI_API_KEY"]
    except KeyError:
        print("âŒ ã‚¨ãƒ©ãƒ¼ï¼šéµãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚GitHub Secretsã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        sys.exit()

    # ==================================================
    # 1. ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
    # ==================================================
    now = datetime.datetime.now()
    month = now.strftime('%m')
    day = now.strftime('%d')
    date_str = f"{month}æœˆ{day}æ—¥"
    
    print(f"æœ¬æ—¥ã®æ—¥ä»˜: {date_str}")

    # ==================================================
    # 2. AIã«ã‚ˆã‚‹ã€Œè£ãƒ†ãƒ¼ãƒé¸å®šã€ï¼†ã€Œè¬ç½ªæ–‡ã€ç”Ÿæˆ
    # ==================================================
    print("AIãŒè¬ç½ªæ–‡ã‚’ä½œæˆä¸­...")
    client = OpenAI(api_key=OPENAI_API_KEY)

    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šå…·ä½“çš„ãªä¾‹æ–‡ã‚’å‰Šé™¤ã—ã€ã€Œç½ªã®ã‚¸ãƒ£ãƒ³ãƒ«ã€ã‚’æŒ‡å®šã—ã¦å¤šæ§˜æ€§ã‚’å‡ºã™
    prompt = f"""
    ã‚ãªãŸã¯ç¤¾ä¼šçš„åœ°ä½ã®ã‚ã‚‹äººç‰©ï¼ˆæ”¿æ²»å®¶ã‚„CEOï¼‰ã¨ã—ã¦ã€Œç·Šæ€¥è¬ç½ªä¼šè¦‹ã€ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
    
    ã€ä»Šæ—¥ã®æ—¥ä»˜ã€‘
    {date_str}

    ã€æŒ‡ç¤ºã€‘
    1. **è£ãƒ†ãƒ¼ãƒ**: ä»Šæ—¥ï¼ˆ{date_str}ï¼‰ãŒä½•ã®è¨˜å¿µæ—¥ã‹çŸ¥è­˜ã‹ã‚‰æ¤œç´¢ã—ã€ãã‚Œã‚’ãƒã‚¿ã®ç€æƒ³å…ƒã«ã—ã¦ãã ã•ã„ã€‚ï¼ˆæŠ•ç¨¿ã«ã¯è¨˜å¿µæ—¥åã¯å‡ºã•ãªã„ã§ãã ã•ã„ï¼‰
    2. **ä¸ç¥¥äº‹ã®å†…å®¹ï¼ˆæœ€é‡è¦ï¼‰**: 
       * è¨˜å¿µæ—¥ã«çµ¡ã‚ã¤ã¤ã€ä»¥ä¸‹ã®**ã€Œäººé–“å‘³ã®ã‚ã‚‹ãƒ€ãƒ¡ãªè¡Œå‹•ãƒªã‚¹ãƒˆã€**ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤ã®è¦ç´ ã‚’é¸ã‚“ã§ã€å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ä½œã£ã¦ãã ã•ã„ã€‚
       
       **ã€äººé–“å‘³ã®ã‚ã‚‹ãƒ€ãƒ¡ãªè¡Œå‹•ãƒªã‚¹ãƒˆã€‘**
       * **æ€ æƒ°**: äºŒåº¦å¯ã€å¾Œå›ã—ã€é¢å€’ãã•ãŒã£ã¦æ‰‹æŠœãã‚’ã—ãŸã€‚
       * **é£Ÿæ¬²**: ã‚«ãƒ­ãƒªãƒ¼ç„¡è¦–ã€å¤œé£Ÿã€äººã®åˆ†ã¾ã§é£Ÿã¹ãŸã€ã¤ã¾ã¿é£Ÿã„ã€‚
       * **è™šå‹¢**: çŸ¥ã£ãŸã‹ã¶ã‚Šã€è¦‹æ „ã‚’å¼µã£ãŸã€è©±ã‚’ç››ã£ãŸã€‚
       * **ä¸æ³¨æ„**: ã‚¹ãƒãƒ›ã‚’è¦‹ãªãŒã‚‰æ­©ã„ãŸã€è¶³ã®å°æŒ‡ã‚’ã¶ã¤ã‘ãŸã€ä¿å­˜ã—å¿˜ã‚ŒãŸã€‚
       * **ç¤¾ä¼šçš„æ°—ã¾ãšã•**: æŒ¨æ‹¶ã‚’ç„¡è¦–ã—ãŸãµã‚Šã‚’ã—ãŸã€åå‰ã‚’å¿˜ã‚Œã¦èª¤é­”åŒ–ã—ãŸã€‚
       * **ç‰©æ¬²**: ç„¡é§„é£ã„ã—ãŸã€é™å®šå“ã«é‡£ã‚‰ã‚ŒãŸã€èª²é‡‘ã—ãŸã€‚

    3. **ç¦æ­¢äº‹é …**: 
       * ã‚·ãƒ¥ãƒ¼ãƒ«ã™ãã‚‹ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ï¼ˆå®‡å®™äººã€é­”æ³•ãªã©ï¼‰ã¯NGã€‚
       * ä¾‹æ–‡ã«å¼•ã£å¼µã‚‰ã‚Œãªã„ã‚ˆã†ã€**æ¯å›å…¨ãé•ã†ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³**ã§æ›¸ã„ã¦ãã ã•ã„ã€‚
    
    4. **ãƒˆãƒ¼ãƒ³**: å†…å®¹ã¯ä¸Šè¨˜ã®ã‚ˆã†ãªã€Œã—ã‚‡ã†ã‚‚ãªã„ã“ã¨ã€ã§ã™ãŒã€æ–‡ç« ã¯**ã€Œå›½å®¶ã®å­˜äº¡ã«é–¢ã‚ã‚‹ãƒ¬ãƒ™ãƒ«ã€ã«é‡è‹¦ã—ãã€ã‚·ãƒªã‚¢ã‚¹**ã«æ›¸ã„ã¦ãã ã•ã„ã€‚
    5. **é•·ã•**: 130å­—ä»¥å†…ï¼ˆæ—¥æœ¬èªï¼‰ã€‚

    ã€å‡ºåŠ›å½¢å¼ã€‘
    ä»¥ä¸‹ã®å½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

    ã€è¬ç½ªä¼šè¦‹ã€‘
    (ã“ã“ã«è¬ç½ªæ–‡)
    #æ¶ç©ºè¬ç½ªä¼šè¦‹ #èª ã«ã”ã‚ã‚“ãªã•ã„ #ãƒ•ã‚©ãƒ­ãƒ100
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": prompt}],
            temperature=1.0, 
        )
        ai_output = response.choices[0].message.content
        print(f"â˜…ç”Ÿæˆçµæœ:\n{ai_output}")

    except Exception as e:
        print(f"ã‚¨ãƒ©ãƒ¼ï¼šAIç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        sys.exit()

    # ==================================================
    # 3. æŠ•ç¨¿
    # ==================================================
    # é€£æŠ•ã‚¨ãƒ©ãƒ¼å›é¿ç”¨ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆç§’æ•°ã¾ã§å«ã‚ã‚‹ã“ã¨ã§å®Œå…¨ã«å›é¿ï¼‰
    # ä¿®æ­£: %H:%M -> %H:%M:%S
    now_time = now.strftime("%H:%M:%S")
    tweet_content = f"{ai_output}\n\n(æ›´æ–°: {now_time})"

    try:
        client_x = tweepy.Client(
            consumer_key=X_API_KEY,
            consumer_secret=X_API_SECRET,
            access_token=X_ACCESS_TOKEN,
            access_token_secret=X_ACCESS_TOKEN_SECRET
        )
        client_x.create_tweet(text=tweet_content)
        print(f"âœ… æŠ•ç¨¿æˆåŠŸï¼ (æ™‚åˆ»: {now_time})")

    except Exception as e:
        print(f"âŒ æŠ•ç¨¿å¤±æ•—ï¼š{e}")
        if "187" in str(e):
            print("ğŸ›‘ é‡è¤‡ã‚¨ãƒ©ãƒ¼ï¼šå†…å®¹ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚")
        elif "403" in str(e):
            print("ğŸ›‘ æ¨©é™ã‚¨ãƒ©ãƒ¼ï¼šGitHubã®éµã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

if __name__ == "__main__":
    main()
